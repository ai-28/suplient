<!DOCTYPE html>
<html>

<head>
    <title>Test Push Notification</title>
</head>

<body>
    <h1>Push Notification Test</h1>
    <button id="testPush">Test Push Notification</button>
    <button id="checkPermission">Check Notification Permission</button>
    <div id="output"></div>

    <script>
        const output = document.getElementById('output');

        // Check notification permission
        document.getElementById('checkPermission').addEventListener('click', () => {
            const permission = Notification.permission;
            output.innerHTML += `<p>Notification Permission: <strong>${permission}</strong></p>`;

            if (permission !== 'granted') {
                Notification.requestPermission().then(perm => {
                    output.innerHTML += `<p>New Permission: <strong>${perm}</strong></p>`;
                });
            }
        });

        // Test push notification
        document.getElementById('testPush').addEventListener('click', async () => {
            output.innerHTML = '<p>Testing push notification...</p>';

            // Check service worker
            if ('serviceWorker' in navigator) {
                try {
                    // Check if service worker is registered
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    output.innerHTML += `<p>üìã Found ${registrations.length} service worker registration(s)</p>`;

                    if (registrations.length === 0) {
                        output.innerHTML += '<p>‚ùå No service worker registered. Make sure you\'re accessing this from your app domain.</p>';
                        return;
                    }

                    // Check service worker state
                    registrations.forEach((reg, index) => {
                        output.innerHTML += `<p>SW ${index + 1}: State = ${reg.active?.state || reg.waiting?.state || reg.installing?.state || 'unknown'}</p>`;
                        output.innerHTML += `<p>SW ${index + 1}: Script = ${reg.active?.scriptURL || reg.waiting?.scriptURL || reg.installing?.scriptURL || 'unknown'}</p>`;
                    });

                    output.innerHTML += '<p>‚è≥ Waiting for service worker to be ready...</p>';

                    // Add timeout
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Service worker ready timeout after 10 seconds')), 10000);
                    });

                    const registration = await Promise.race([
                        navigator.serviceWorker.ready,
                        timeoutPromise
                    ]);

                    output.innerHTML += '<p>‚úÖ Service Worker is ready</p>';

                    // Check notification permission first
                    const permission = Notification.permission;
                    output.innerHTML += `<p>Notification Permission: <strong>${permission}</strong></p>`;

                    if (permission === 'granted') {
                        output.innerHTML += '<p>‚úÖ Permission is granted, showing test notification...</p>';
                        // Try to show a notification directly
                        try {
                            await registration.showNotification('Test Notification', {
                                body: 'This is a test notification from the service worker',
                                icon: '/assets/icons/icon-192x192.svg',
                                badge: '/assets/icons/icon-96x96.svg',
                                tag: 'test-' + Date.now()
                            });
                            output.innerHTML += '<p>‚úÖ Notification shown successfully! Check your desktop notifications.</p>';
                        } catch (err) {
                            output.innerHTML += `<p>‚ùå Error showing notification: ${err.message}</p>`;
                            console.error('Notification error:', err);
                        }
                    } else {
                        output.innerHTML += '<p>‚ö†Ô∏è Notification permission not granted. Click "Check Notification Permission" button.</p>';
                    }

                    // Check push subscription status
                    const pushSubscription = await registration.pushManager.getSubscription();
                    if (pushSubscription) {
                        output.innerHTML += '<p>‚úÖ Push subscription exists</p>';
                        output.innerHTML += `<p>Endpoint: ${pushSubscription.endpoint.substring(0, 60)}...</p>`;
                    } else {
                        output.innerHTML += '<p>‚ö†Ô∏è No push subscription found. Enable push notifications in the app to receive push events.</p>';
                    }

                    output.innerHTML += '<p><strong>Test complete!</strong></p>';
                } catch (error) {
                    output.innerHTML += `<p>‚ùå Error: ${error.message}</p>`;
                }
            } else {
                output.innerHTML += '<p>‚ùå Service Worker not supported</p>';
            }
        });

        // Listen for messages from service worker
        navigator.serviceWorker.addEventListener('message', (event) => {
            output.innerHTML += `<p>üì® Message from SW: ${JSON.stringify(event.data)}</p>`;
            console.log('Message from service worker:', event.data);
        });

        // Check on load
        window.addEventListener('load', () => {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(reg => {
                    output.innerHTML += '<p>‚úÖ Service Worker ready on page load</p>';
                });
            }
        });
    </script>
</body>

</html>